{"version":3,"file":"main.min.js","sources":["../src/main.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main js functions for block_timezoneclock\n *\n * @module block_timezoneclock/main\n * @copyright 2022 Harshil Patel <harshil8595@gmail.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport DynamicForm from 'core_form/dynamicform';\nimport {replaceNodeContents} from 'core/templates';\nimport Fragment from 'core/fragment';\nimport {exception as displayException} from 'core/notification';\nimport {eventTypes} from 'core_filters/events';\n\nconst GMTCONST = 'GMT';\nconst dtOptions = {\n    year: 'numeric',\n    month: 'short',\n    weekday: 'short',\n    day: 'numeric',\n    hour: 'numeric',\n    minute: 'numeric',\n    second: 'numeric',\n    hour12: true\n};\nlet select2registered = false;\n\nconst getDateInfo = (timeZone, timestamp = new Date(), customdateOptions = {}) => {\n    customdateOptions = {...dtOptions, ...customdateOptions, timeZone};\n    const t1 = new Intl.DateTimeFormat('en-us', customdateOptions);\n    const dateInfo = t1.formatToParts(timestamp).reduce((a, i) => ({...a, [i.type]: i.value}), {});\n    return {...dateInfo, day: dateInfo.day.padStart(2, 0)};\n};\n\nconst updateTime = () => {\n    document.querySelectorAll('[data-region=\"clock\"]:not([data-autoupdate=\"false\"])')\n    .forEach(clock => {\n        const datefractions = getDateInfo(clock.dataset.timezone);\n        clock.querySelectorAll('[data-fraction]').forEach(sp => {\n            const {fraction, unit} = sp.dataset;\n            if (unit?.toString() !== datefractions[fraction].toString()) {\n                sp.style.setProperty(`--unit`, datefractions[fraction]);\n                sp.setAttribute('data-unit', datefractions[fraction]);\n                sp.firstElementChild.innerText = datefractions[fraction].toString();\n            }\n        });\n    });\n    setTimeout(updateTime, 1000);\n};\n\nexport const makeSelectEnhanced = (parentNode = document) => {\n    require(['theme_boost/index', `${M.cfg.wwwroot}/blocks/timezoneclock/bootstrap-select/js/bootstrap-select.min.js`], () => {\n        const $spnodes = $(parentNode).find('[data-selectenhanced=\"1\"]');\n        $spnodes.removeClass(['form-control', 'custom-select']);\n        $spnodes.selectpicker({\n            actionsBox: true, liveSearch: true, showTick: true,\n            size: 5, selectedTextFormat: 'count > 1',\n        });\n    });\n};\n\nexport const initBlock = () => {\n    const d = new Date();\n    setTimeout(updateTime, 1000 - d.getMilliseconds());\n    if (!select2registered) {\n        select2registered = true;\n        document.addEventListener(eventTypes.filterContentUpdated, e => {\n            makeSelectEnhanced(e.detail.nodes);\n        });\n    }\n};\n\nexport const registerForm = formUniqId => {\n    const form = document.getElementById(formUniqId);\n    const r = new RegExp(`(day|month|year|hour|minute)`);\n    if (form) {\n        const dForm = new DynamicForm(form, form.dataset.formClass);\n        const getTypeFromElement = sel => sel.name.match(r).pop();\n        const generateTimeStamp = () => {\n            const timestampInput = dForm.getFormNode().elements.timestamp;\n            const timezoneSelection = dForm.getFormNode().elements.timezone;\n            const dateTimeNode = dForm.getFormNode().querySelector('[data-fieldtype=\"date_time_selector\"]');\n            const fractions = [...dateTimeNode.querySelectorAll('select')]\n            .reduce((acc, sel) => ({...acc, [getTypeFromElement(sel)]: sel.value.padStart(2, 0)}), {});\n            const {year, month, day, hour, minute} = fractions;\n\n            const date = new Date(`${year}-${month}-${day}T${hour}:${minute}:00.000`);\n            const dateinfo = getDateInfo(timezoneSelection.value, date, {timeZoneName: 'longOffset'});\n            const gmtOffset = dateinfo.timeZoneName.split(GMTCONST).pop();\n\n            const d = new Date(date + gmtOffset);\n            timestampInput.value = Math.round(d.valueOf() / 1000);\n        };\n        const clientTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;\n        const urlParams = new URLSearchParams([\n            ...(new URLSearchParams(location.search)).entries(),\n            ...Object.entries({...form.dataset, timezone: clientTimezone})\n        ]);\n        dForm.load(Object.fromEntries(urlParams)).then(() => {\n            if (form.nextElementSibling.childElementCount === 0) {\n                dForm.submitFormAjax({firstload: 1});\n            }\n            return;\n        }).catch(displayException);\n        dForm.addEventListener(dForm.events.FORM_SUBMITTED, e => {\n            e.preventDefault();\n            replaceNodeContents(form.nextElementSibling, e.detail.html,\n                Fragment.processCollectedJavascript(e.detail.js));\n        });\n        dForm.addEventListener('change', e => {\n            const dateTimeNode = e.target.closest('[data-fieldtype=\"date_time_selector\"]');\n            const timezoneSelection = e.target.closest('[name=\"timezone\"]');\n            if (dateTimeNode || timezoneSelection) {\n                generateTimeStamp();\n            }\n        });\n        dForm.addEventListener('change', e => {\n            const timestampInput = e.target.closest('[name=\"timestamp\"]');\n            const timezoneSelection = dForm.getFormNode().elements.timezone;\n            const dateTimeNode = dForm.getFormNode().querySelector('[data-fieldtype=\"date_time_selector\"]');\n            if (timestampInput) {\n                const d = new Date(0);\n                d.setUTCSeconds(timestampInput.value);\n                const info = getDateInfo(timezoneSelection.value, d, {month: 'numeric', hour12: false});\n                info.hour = Number(info.hour);\n                dateTimeNode.querySelectorAll('select').forEach(sel => {\n                    sel.value = info[getTypeFromElement(sel)];\n                });\n            }\n        });\n    }\n};\n"],"names":["dtOptions","year","month","weekday","day","hour","minute","second","hour12","select2registered","getDateInfo","timeZone","timestamp","Date","customdateOptions","t1","Intl","DateTimeFormat","dateInfo","formatToParts","reduce","a","i","type","value","padStart","updateTime","document","querySelectorAll","forEach","clock","datefractions","dataset","timezone","sp","fraction","unit","toString","style","setProperty","setAttribute","firstElementChild","innerText","setTimeout","makeSelectEnhanced","parentNode","require","M","cfg","wwwroot","$spnodes","find","removeClass","selectpicker","actionsBox","liveSearch","showTick","size","selectedTextFormat","d","getMilliseconds","addEventListener","eventTypes","filterContentUpdated","e","detail","nodes","formUniqId","form","getElementById","r","RegExp","dForm","DynamicForm","formClass","getTypeFromElement","sel","name","match","pop","generateTimeStamp","timestampInput","getFormNode","elements","timezoneSelection","fractions","querySelector","acc","date","gmtOffset","timeZoneName","split","Math","round","valueOf","clientTimezone","resolvedOptions","urlParams","URLSearchParams","location","search","entries","Object","load","fromEntries","then","nextElementSibling","childElementCount","submitFormAjax","firstload","catch","displayException","events","FORM_SUBMITTED","preventDefault","html","Fragment","processCollectedJavascript","js","dateTimeNode","target","closest","setUTCSeconds","info","Number"],"mappings":"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"}